const BLINK_CODE = "22221223211121322212113221121232211112322122123221222132211112322122123221121232212111322111123222112232212111321112132221213211121322211132212223221221322112113221112322112232221113221212322111132211113221212322111232211122322122232212123221121322112213221112132211122322122132211211322121232211213221112322112213221122322112113221122132211113221112232211213221121132212113221222322112232211123221112132212213221221322211132111213212211321112132211122322122223221121132211212322211223211121322212132122122322221223211121322211223221121232212211322112123221112232221211322211113221211232212221321112132221213221211321221132111213221112232212222322122123221221232211112322122213221121132111213222121321112132211211322121123221122232212112322212113221111232212211321212223222112132212112322212113221121232111213212211321112132221111322111123222112132211112322122123221121232221211322112123222112132111213222121322111232122113211121322122113221121232212221322112223222121132212111321112132221213221121322121232211113222221232122113222212232111213222112232211212322122113221121232211122322212113222111132212112322122213211121322212132212113212211321112132211122322122223221221232212212322111123221222132211211321112132221213211121322112113221211232211222322121123222121132211112322122113212122232221121322121123222121132211212321112132122113211121322211113221111232221121322111123221221232211212322212113221121232221121321112132221213221111321221132111213221221132211212322122213221122232221211322121113211121322212132211213221212322111132222212321221132222122321112132221122322112123221221132211212322111223222121132221111322121123221222132111213222121322121132122113211121322111223221222232212212322122123221111232212221322112113211121322212132111213221121132212112322112223221211232221211322111123221221132121222322211213221211232221211322112123211121321221132111213222111132211112322211213221111232212212322112123222121132211212322211213211121322212132211123212211321112132212211322112123221222132211222322212113221211132111213222121322112132212123221111322222123212211322221223211121322211223221121232212211322112123221112232221211322211113221211232212221321112132221213221211321221132111213221112232212222322122123221221232211112322122213221121132111213222121321112132211211322121123221122232212112322212113221111232212211321212223222112132212112322212113221121232111213212211321112132221111322111123222112132211112322122123221121232221211322112123222112132111213222121322111132122113211121322122113221121232212221322112223222121132212111321112132221213221121322121232211113222221232122212322222123";

function load() {
    if (cookie_has("team")) get("team").value = cookie_pull("team");
    if (cookie_has("code") && cookie_pull("code") === "true") {
        show("code-entry");
        hide("blink");
    } else {
        show("blink");
        hide("code-entry");
    }
}

function cookie_pull(name) {
    name += "=";
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
        let cookie = cookies[i];
        while (cookie.charAt(0) === ' ') {
            cookie = cookie.substring(1);
        }
        if (cookie.indexOf(name) === 0) {
            return decodeURIComponent(cookie.substring(name.length, cookie.length));
        }
    }
    return undefined;
}

function cookie_push(name, value) {
    const date = new Date();
    date.setTime(value !== "" ? date.getTime() + (365 * 24 * 60 * 60 * 1000) : 0);
    document.cookie = name + "=" + encodeURIComponent(value) + ";expires=" + date.toUTCString() + ";domain=" + window.location.hostname + ";path=/";
}

function cookie_has(name) {
    return cookie_pull(name) !== undefined;
}

function send(compiled) {
    if (get("team").value.length > 0) {
        api("scripts/backend/pushthebot/pushthebot.php", "pushthebot", "pushcode", {
            code: compiled,
            team: get("team").value
        }, (success, result, error) => {
            console.log("---------------------------------------");
            if (success) {
                get("output").style.color = "green";
                get("output").innerText = result;
            } else {
                get("output").style.color = "red";
                get("output").innerText = error;
            }
        });
    } else {
        get("team").style.position = "relative";
        animate("team", "left", ["0px", "-20px", "0px", "20px", "0px", "-20px", "0px", "20px", "0px"], 0.1);
    }
}

function compile(rawcode) {
    return rawcode;
}

function encode(str) {
    if (str.length === 0) return "";
    let c = str[0];
    let r = "";
    let cks = 0;
    c = c.charCodeAt(0);
    while (c > 0) {
        if ((c & 1) === 1) {
            r = "2" + r;
            cks++;
        } else {
            r = "1" + r;
            cks++;
            cks++;
        }
        c >>= 1;
    }
    return r + "3" + encode(str.substr(1));
}

// TODO remove "decode"

function decode(str) {
    if (str.length === 0) return "";
    let s = 0;
    let i;
    for (i = 0; i < str.length; i++) {
        let c = str[i];
        if (c === "3") break;
        s <<= 1;
        if (c === "2") s += 1;
    }
    return String.fromCharCode(s) + decode(str.substr(i + 1));
}